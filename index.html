<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特練シミュレータ Pro v4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="showTab('sim')">シミュレーター</button>
    <button class="tab-btn" onclick="showTab('inventory')">所持カード</button>
    <button class="tab-btn admin-tab" onclick="showTab('admin-card')">カード管理</button>
    <button class="tab-btn admin-tab" onclick="showTab('admin-skill')">スキル/アビ管理</button>
</nav>

<!-- シミュレーター -->
<div id="sim" class="content active">
    <!-- 1. ステータス入力 -->
    <div class="card-box" style="border-color: #3b82f6;">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleDisp('statInputArea')">
            <label style="color:#3b82f6; font-weight:bold;">▼ 育成選手のステータス入力 (現在値 / 最大値)</label>
            <span style="font-size:0.8rem;">開閉</span>
        </div>
        
        <!-- OCR & プロファイル管理エリア -->
        <div style="margin-top:10px; border-top:1px solid #334155; padding-top:10px;">
            <label style="font-size:0.7rem; color:#94a3b8; display:block; margin-bottom:5px;">スクリーンショット(16:9)から自動抽出</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="file" id="ocrUpload" accept="image/*" style="display:none;" onchange="handleOCR(this)">
                <button class="btn" style="background:#3b82f6; width:auto; font-size:0.75rem; padding:5px 15px;" onclick="document.getElementById('ocrUpload').click()">画像を選択</button>
                <span id="ocrStatus" style="font-size:0.7rem; color:var(--skill);"></span>
            </div>
            
            <!-- 追加機能: プロファイル保存/読込 -->
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #334155; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <label style="font-size:0.7rem; color:#94a3b8; width:100%;">保存済み設定の呼び出し・保存</label>
                <select id="profileSelect" style="flex:1; min-width:120px;" onchange="loadSelectedProfile()">
                    <option value="">-- データを選択 --</option>
                </select>
                <input type="text" id="profileName" placeholder="保存名(例: ハーランド)" style="flex:1; min-width:120px;">
                <button class="btn btn-sm btn-accent" style="width:auto; margin:0;" onclick="saveCurrentProfile()">保存</button>
                <button class="btn btn-sm" style="width:auto; margin:0; background:#ef4444;" onclick="deleteSelectedProfile()">削除</button>
            </div>
        </div>

        <div id="statInputArea" class="stat-grid" style="display:none; margin-top:10px;"></div>
    </div>

    <!-- 2. プレイスタイル & ターゲット選択 -->
    <div id="selectionArea" class="selector-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="color:var(--accent); font-weight:bold; font-size:0.8rem;">育成設定</label>
            <span id="reselectionBtn" style="font-size:0.7rem; color:var(--primary); display:none;" onclick="expandSelection()">変更する</span>
        </div>

        <!-- 決定後の要約（最初は隠す） -->
        <div id="selectionSummary" class="selected-summary" style="display:none;" onclick="expandSelection()">
            <div id="summaryText" style="font-size:0.85rem; font-weight:bold;"></div>
            <img id="summaryIcon" src="" style="height:30px; border-radius:4px;">
        </div>

        <!-- 選択エリア本体 -->
        <div id="selectionMain">
            <div id="posGrid" class="pos-grid"></div>
            <div id="styleGrid" class="style-grid collapsed"></div>
        </div>
        
        <!-- ターゲット選択（スキル・アビリティ）はそのまま下に配置 -->
        <div style="margin-top:10px; border-top: 1px solid #334155; padding-top:10px;">
            <label style="font-size:0.7rem; color:var(--skill);">必須スキル (最大3つ)</label>
            <div id="skillTargetContainer" class="tag-selector-grid"></div>
            <label style="font-size:0.7rem; color:var(--ability); margin-top:8px; display:block;">必須アビリティ (最大3つ)</label>
            <div id="abilityTargetContainer" class="tag-selector-grid"></div>
        </div>
    </div>
    <!-- 3. 特練スロット -->
    <div id="simSlots" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>

    <!-- 4. 設定 & オート -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
        <div class="card-box" style="margin-bottom:0;">
            <label>コンディション</label>
            <div class="condition-selector">
                <button type="button" class="cond-btn active" onclick="changeCondition(1.0, this)">普通</button>
                <button type="button" class="cond-btn" onclick="changeCondition(1.25, this)">好調</button>
                <button type="button" class="cond-btn" onclick="changeCondition(1.5, this)">絶好調</button>
            </div>
            <!-- 数値を保持するための隠し要素 -->
            <input type="hidden" id="conditionMod" value="1.0">
        </div>
        <div class="card-box" style="margin-bottom:0; border: 2px solid var(--skill);">
            <label style="color:var(--skill); font-weight:bold; font-size:0.8rem;">🤖 最適化オート編成</label>
            <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                <input type="range" id="targetPct" min="50" max="120" value="100" step="5" oninput="document.getElementById('targetPctDisp').innerText=this.value">
                <span id="targetPctDisp" style="font-size:0.7rem; min-width:25px;">100</span>%
            </div>
            <button class="btn" style="background:var(--skill); color:#000; font-size:0.75rem; padding:5px;" onclick="runAutoSim()">所持カードから最適化</button>
        </div>
    </div>

    <!-- 5. 結果 -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div id="totalResults" class="card-box"></div>
        <div id="saResults" class="card-box"></div>
    </div>
</div>

<!-- 所持カード管理 -->
<div id="inventory" class="content">
    <div class="card-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4>My Cards (所持状況 & レベル)</h4>
            <div>
                <button class="btn btn-sm btn-primary" onclick="invSetAll(true)">全所持</button>
                <button class="btn btn-sm" onclick="invSetAll(false)">全解除</button>
            </div>
        </div>
        <p style="font-size:0.75rem; color:#94a3b8;">チェックを入れたカードのみシミュレータで使用します。レベルを指定するとステータスが変動します。</p>
        <div id="invList" class="inv-grid" style="margin-top:10px;"></div>
    </div>
</div>

<!-- カード管理 (Admin) -->
<div id="admin-card" class="content">
    <!-- 追加機能: バックアップ -->
    <div class="card-box" style="border:1px solid var(--skill); margin-bottom: 15px;">
        <h4 style="color:var(--skill);">データバックアップ (JSON)</h4>
        <p style="font-size:0.7rem; color:#94a3b8;">ブラウザのキャッシュ消去対策として、以下のテキストをメモ帳等に保存してください。</p>
        <textarea id="backupArea" style="height:80px; font-size:0.7rem; color:#fff; background:#000; border:1px solid #333; width:100%;" placeholder="ここにバックアップデータが出力されます"></textarea>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button class="btn btn-sm btn-primary" onclick="exportBackup()">データ書き出し</button>
            <button class="btn btn-sm btn-accent" onclick="importBackup()">貼り付けたデータから復元</button>
        </div>
    </div>

    <div class="card-box">
        <h4>GitHub設定</h4>
        <input type="password" id="ghToken" placeholder="GitHub Token">
        <input type="text" id="ghRepo" placeholder="user/repo" style="margin-top:5px;">
    </div>
    <div class="card-box">
        <h4>JSON一括登録</h4>
        <textarea id="aiPasteCard" placeholder="カードデータを貼り付け" style="height:60px;"></textarea>
        <button class="btn btn-accent" onclick="batchRegisterCards()">一括保存</button>
    </div>
    <div class="card-box" id="cardEditor" style="border:2px solid var(--primary);">
        <h4>個別編集</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><input id="editName" placeholder="選手名"><input id="editTitle" placeholder="【称号】"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
            <select id="editRarity"><option>SSR</option><option>SR</option></select>
            <input id="editAbilityName" placeholder="スキル/アビ名" list="skillList">
        </div>
        
        <!-- ボーナスUI -->
        <div style="margin-top:10px; border:1px dashed #555; padding:5px;">
            <label style="font-size:0.7rem;">ボーナス条件 (複数可)</label>
            <div id="editBonusList"></div>
            <button class="btn btn-sm" onclick="addBonusRow()">+ 条件追加</button>
        </div>

        <div class="stat-grid" id="editStatsGrid"></div>
        <button class="btn btn-accent" onclick="saveCardToGH()">保存</button>
    </div>
    <div id="masterList"></div>
</div>

<!-- スキル管理 (Admin) -->
<div id="admin-skill" class="content">
    <div class="card-box" id="saEditor" style="border:2px solid var(--primary)">
        <h4>スキル/アビリティ編集</h4>
        <select id="saType" onchange="toggleAreaGrid()"><option value="skill">SKILL (%)</option><option value="ability">ABILITY (固定値)</option></select>
        <input id="saName" placeholder="名称" style="margin-top:5px;">
        <input id="saValue" placeholder="数値" type="number" style="margin-top:5px;">
        <input id="saCondition" placeholder="発動条件" style="margin-top:5px;">
        <div id="saTargets" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(90px, 1fr)); gap:5px; margin-top:10px;"></div>
        <div id="areaContainer" style="margin-top:10px;">
            <label>発動エリア:</label><div class="area-grid" id="saAreaGrid"></div>
        </div>
        <button class="btn btn-accent" onclick="saveSA()">保存</button>
        <button class="btn" style="margin-top:10px; background:#444;" onclick="document.getElementById('saListArea').style.display='block'">一覧を表示</button>
    </div>
    <div id="saListArea" style="display:none;">
        <div class="card-box"><textarea id="aiPasteSA" placeholder="JSON一括貼り付け" style="height:50px;"></textarea><button class="btn btn-sm" onclick="batchRegisterSA()">JSON保存</button></div>
        <div id="saList"></div>
    </div>
</div>

<!-- モーダル -->
<div id="cardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; padding:20px; overflow-y:auto;">
    <div id="modalList"></div><button class="btn" onclick="document.getElementById('cardModal').style.display='none'">閉じる</button>
</div>

<div id="admin-status">コマンド入力待機中... (10秒以内に入力)</div>


<datalist id="skillList"></datalist>
<datalist id="styleSuggestions"></datalist>

<!-- JSファイルの読み込み順序が重要です -->
<script src="js/config.js"></script>
<script src="js/data_manager.js"></script>
<script src="js/core_logic.js"></script>
<script src="js/ocr_logic.js"></script>
<script src="js/ui_manager.js"></script>
<script src="js/app.js"></script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹ç·´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ Pro v3.3</title>
    <!-- OCRãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #00f2ff; --accent: #22c55e; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --skill: #fbbf24; --ability: #a78bfa; --gk: #f97316; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        nav { background: #000; padding: 10px; display: flex; gap: 5px; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #334155; color: white; border-radius: 6px; cursor: pointer; white-space: nowrap; font-size: 0.85rem; }
        .tab-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        .content { display: none; padding: 15px; max-width: 1000px; margin: 0 auto; }
        .content.active { display: block; }
        .card-box { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        input, textarea, select { background: #000; border: 1px solid #334155; color: #fff; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; margin-top: 5px; width: 100%; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-edit { background: #3b82f6; color: #fff; width: auto; padding: 5px 10px; font-size: 0.7rem; margin-right: 5px; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; margin-top: 10px; }
        .stat-item label { display: block; font-size: 0.7rem; color: #94a3b8; margin-bottom: 2px; }
        .gk-stat { border-color: var(--gk); } .gk-stat label { color: var(--gk); }
        .slot-active { border: 2px solid var(--primary); background: rgba(0,242,255,0.1); }
        .slot-empty { border: 2px dashed #444; }
        .bonus-on { color: var(--accent); font-weight: bold; }
        .bonus-off { color: #ef4444; text-decoration: line-through; opacity: 0.6; }
        .tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .tag-skill { background: var(--skill); color: #000; }
        .tag-ability { background: var(--ability); color: #fff; }
        .area-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; width: 120px; margin-top: 5px; }
        .area-cell { height: 35px; background: #444; cursor: pointer; border: 1px solid #555; }
        .area-cell.active { background: var(--skill); border: 1px solid white; }
        .sa-result-area { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; width: 50px; height: 50px; margin-right: 10px; flex-shrink: 0; }
        .sa-result-cell { background: #333; }
        .sa-result-cell.active { background: var(--skill); }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="showTab('sim')">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
    <button class="tab-btn" onclick="showTab('admin-card')">ã‚«ãƒ¼ãƒ‰ç®¡ç†</button>
    <button class="tab-btn" onclick="showTab('admin-skill')">ã‚¹ã‚­ãƒ«/ã‚¢ãƒ“ç®¡ç†</button>
</nav>

<!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ -->
<div id="sim" class="content active">
    <!-- 1. é¸æ‰‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="card-box" style="border-color: #3b82f6;">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="document.getElementById('statInputArea').style.display = document.getElementById('statInputArea').style.display==='none'?'grid':'none'">
            <label style="color:#3b82f6; font-weight:bold;">â–¼ è‚²æˆé¸æ‰‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ› (ç¾åœ¨å€¤ / æœ€å¤§å€¤)</label>
            <span style="font-size:0.8rem;">é–‹é–‰</span>
        </div>
        <!-- OCRãƒœã‚¿ãƒ³ -->
        <div style="margin-top:10px; border-top:1px solid #334155; padding-top:10px;">
            <label style="font-size:0.7rem; color:#94a3b8; display:block; margin-bottom:5px;">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ(16:9)ã‹ã‚‰è‡ªå‹•æŠ½å‡º</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="file" id="ocrUpload" accept="image/*" style="display:none;" onchange="handleOCR(this)">
                <button class="btn" style="background:#3b82f6; width:auto; font-size:0.75rem; padding:5px 15px;" onclick="document.getElementById('ocrUpload').click()">ç”»åƒã‚’é¸æŠ</button>
                <span id="ocrStatus" style="font-size:0.7rem; color:var(--skill);"></span>
            </div>
        </div>
        <div id="statInputArea" class="stat-grid" style="display:none; margin-top:10px;">
            <!-- JSã§è‡ªå‹•ç”Ÿæˆ -->
        </div>
    </div>

    <!-- 2. ãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«å…¥åŠ› -->
    <div class="card-box" style="border-color: var(--accent);">
        <label style="color:var(--accent); font-weight:bold; font-size:0.8rem;">è‚²æˆé¸æ‰‹ã®ãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«</label>
        <input type="text" id="traineeStyle" placeholder="ä¾‹: ã‚¢ã‚¿ãƒƒã‚«ãƒ¼" oninput="updateCalc()" list="styleSuggestions">
        <datalist id="styleSuggestions"></datalist>
    </div>

    <!-- 3. ç‰¹ç·´ã‚¹ãƒ­ãƒƒãƒˆ -->
    <div id="simSlots" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>

    <!-- 4. è¨­å®šï¼ˆã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ & ã‚ªãƒ¼ãƒˆç·¨æˆï¼‰ -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
        <div class="card-box" style="margin-bottom:0;">
            <label>ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</label>
            <select id="conditionMod" onchange="updateCalc()">
                <option value="1.0">æ™®é€š</option>
                <option value="1.25">å¥½èª¿</option>
                <option value="1.5">çµ¶å¥½èª¿</option>
            </select>
        </div>
        <div class="card-box" style="margin-bottom:0; border: 2px solid var(--skill);">
            <label style="color:var(--skill); font-weight:bold; font-size:0.8rem;">ğŸ¤– æœ€é©åŒ–ã‚ªãƒ¼ãƒˆç·¨æˆ</label>
            <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                <input type="range" id="targetPct" min="50" max="120" value="100" step="5" oninput="document.getElementById('targetPctDisp').innerText=this.value">
                <span id="targetPctDisp" style="font-size:0.7rem; min-width:25px;">100</span>%
            </div>
            <button class="btn" style="background:var(--skill); color:#000; font-size:0.75rem; padding:5px;" onclick="runAutoSim()">æœ€é©ç·¨æˆã‚’å®Ÿè¡Œ</button>
        </div>
    </div>

    <!-- 5. çµæœè¡¨ç¤º -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div id="totalResults" class="card-box"></div>
        <div id="saResults" class="card-box"></div>
    </div>
</div>

<!-- ã‚«ãƒ¼ãƒ‰ç®¡ç† -->
<div id="admin-card" class="content">
    <div class="card-box">
        <h4>GitHubè¨­å®š</h4>
        <input type="password" id="ghToken" placeholder="GitHub Token">
        <input type="text" id="ghRepo" placeholder="user/repo" style="margin-top:5px;">
    </div>
    <div class="card-box">
        <h4>JSONä¸€æ‹¬ç™»éŒ²</h4>
        <textarea id="aiPasteCard" placeholder="ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘" style="height:60px;"></textarea>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button class="btn" onclick="loadCardToEditor()">ã‚¨ãƒ‡ã‚£ã‚¿ã¸</button>
            <button class="btn btn-accent" onclick="batchRegisterCards()">ä¸€æ‹¬ä¿å­˜</button>
        </div>
    </div>
    <div class="card-box" id="cardEditor" style="border:2px solid var(--primary);">
        <h4>å€‹åˆ¥ç·¨é›†</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><input id="editName" placeholder="é¸æ‰‹å"><input id="editTitle" placeholder="ã€ç§°å·ã€‘"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:5px;">
            <select id="editRarity"><option>SSR</option><option>SR</option></select>
            <input id="editBonusType" placeholder="æ¡ä»¶ã‚¹ã‚¿ã‚¤ãƒ«">
            <input id="editBonusVal" type="number" placeholder="ãƒœãƒ¼ãƒŠã‚¹%">
        </div>
        <input id="editAbilityName" placeholder="ã‚¹ã‚­ãƒ«/ã‚¢ãƒ“å" list="skillList" style="margin-top:5px;">
        <datalist id="skillList"></datalist>
        <div class="stat-grid" id="editStatsGrid"></div>
        <button class="btn btn-accent" onclick="saveCardToGH()">ä¿å­˜</button>
    </div>
    <div id="masterList"></div>
</div>

<!-- ã‚¹ã‚­ãƒ«/ã‚¢ãƒ“ç®¡ç† -->
<div id="admin-skill" class="content">
    <div class="card-box">
        <h4>JSONä¸€æ‹¬ç™»éŒ²</h4>
        <textarea id="aiPasteSA" placeholder="ã‚¹ã‚­ãƒ«/ã‚¢ãƒ“ãƒªãƒ†ã‚£JSONã‚’è²¼ã‚Šä»˜ã‘" style="height:100px;"></textarea>
        <button class="btn btn-accent" onclick="batchRegisterSA()">ä¸€æ‹¬æ›´æ–°ä¿å­˜</button>
    </div>
    <div class="card-box" id="saEditor" style="border:2px solid var(--primary)">
        <h4>å€‹åˆ¥ä½œæˆ/ç·¨é›†</h4>
        <select id="saType" onchange="toggleAreaGrid()"><option value="skill">SKILL (%)</option><option value="ability">ABILITY (å›ºå®šå€¤)</option></select>
        <input id="saName" placeholder="åç§°" style="margin-top:5px;">
        <input id="saValue" placeholder="æ•°å€¤" type="number" style="margin-top:5px;">
        <input id="saCondition" placeholder="ç™ºå‹•æ¡ä»¶" style="margin-top:5px;">
        <div id="saTargets" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(90px, 1fr)); gap:5px; margin-top:10px;"></div>
        <div id="areaContainer" style="margin-top:10px;">
            <label>ç™ºå‹•ã‚¨ãƒªã‚¢:</label><div class="area-grid" id="saAreaGrid"></div>
        </div>
        <button class="btn btn-accent" onclick="saveSA()">ä¿å­˜</button>
    </div>
    <div id="saList"></div>
</div>

<!-- ã‚«ãƒ¼ãƒ‰é¸æŠç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="cardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; padding:20px; overflow-y:auto;">
    <div id="modalList"></div><button class="btn" onclick="document.getElementById('cardModal').style.display='none'">é–‰ã˜ã‚‹</button>
</div>

<script>
    const STATS = ["æ±ºå®šåŠ›","ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ã‚¹","çªç ´åŠ›","ã‚¸ãƒ£ãƒ³ãƒ—","èµ°åŠ›","ã‚­ãƒƒã‚¯åŠ›","ãƒ­ãƒ³ã‚°ãƒ‘ã‚¹","ã‚­ãƒ¼ãƒ—åŠ›","ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ","æ•æ·æ€§","å†·é™ã•","ã‚­ãƒƒã‚¯ç²¾åº¦","ãƒœãƒ¼ãƒ«ã‚¿ãƒƒãƒ","ã‚¹ã‚¿ãƒŸãƒŠ","ã‚¿ãƒƒã‚¯ãƒ«","ãƒ‘ã‚¹ã‚«ãƒƒãƒˆ","ãƒãƒ¼ã‚¯","ã‚»ãƒ¼ãƒ“ãƒ³ã‚°","åå¿œé€Ÿåº¦","1å¯¾1"];
    const GK_STATS = ["ã‚»ãƒ¼ãƒ“ãƒ³ã‚°","åå¿œé€Ÿåº¦","1å¯¾1"];
    let cardsDB = [], skillsDB = [], abilitiesDB = [], selectedSlots = Array(6).fill(null), activeSlotIndex = null;

    window.onload = async () => {
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('traineeStyle').value = localStorage.getItem('trainee_style') || '';
        
        // ã‚«ãƒ¼ãƒ‰ç·¨é›†ç”¨UI
        const grid = document.getElementById('editStatsGrid');
        STATS.forEach(s => grid.innerHTML += `<div class="stat-item ${GK_STATS.includes(s)?'gk-stat':''}"><label>${s}</label><input type="number" step="0.1" class="edit-val" data-stat="${s}"></div>`);
        
        // é¸æ‰‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥åŠ›ã‚¨ãƒªã‚¢ç”Ÿæˆ
        const inputArea = document.getElementById('statInputArea');
        STATS.forEach(s => {
            const isGk = GK_STATS.includes(s);
            inputArea.innerHTML += `
                <div class="stat-item ${isGk?'gk-stat':''}" style="background:#0f172a; padding:5px; border-radius:4px;">
                    <label>${s}</label>
                    <div style="display:flex; gap:2px;">
                        <input type="number" placeholder="ç¾åœ¨" id="now_${s}" onchange="updateCalc()" style="font-size:0.7rem; padding:4px;">
                        <input type="number" placeholder="æœ€å¤§" id="max_${s}" onchange="updateCalc()" style="font-size:0.7rem; padding:4px;">
                    </div>
                    <div id="gap_${s}" style="text-align:right; font-size:0.7rem; color:#64748b;">æ®‹: -</div>
                </div>`;
        });

        const saTgt = document.getElementById('saTargets');
        STATS.forEach(s => saTgt.innerHTML += `<label style="font-size:0.7rem;"><input type="checkbox" value="${s}" name="sa_tgt"> ${s}</label>`);
        
        const areaGrid = document.getElementById('saAreaGrid');
        for(let i=0; i<9; i++) areaGrid.innerHTML += `<div class="area-cell" onclick="this.classList.toggle('active')"></div>`;
        
        initSimSlots(); await fetchAllDB();
    };

    async function fetchAllDB() {
        const ts = Date.now(), base = './data';
        try {
            const [c, s, a] = await Promise.all([ fetch(`${base}/cards.json?t=${ts}`), fetch(`${base}/skills.json?t=${ts}`), fetch(`${base}/abilities.json?t=${ts}`) ]);
            if(c.ok) cardsDB = await c.json(); if(s.ok) skillsDB = await s.json(); if(a.ok) abilitiesDB = await a.json();
            renderCardList(); renderSAList(); updateAutoComplete(); updateCalc();
        } catch(e) { console.error(e); }
    }

    // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (æ•´æ•°x10 ï¼‹ SSRåˆ†æ¯è£œæ­£)
    function updateCalc() {
        const conditionStr = document.getElementById('conditionMod').value;
        const mult = parseFloat(conditionStr);
        const style = document.getElementById('traineeStyle').value;
        localStorage.setItem('trainee_style', style);
        
        const totals_x10 = {}; 
        const saList = new Set();
        
        selectedSlots.forEach(card => {
            if(!card) return;
            const L = card.rarity === 'SSR' ? 50 : 45;
            const bonusPct = (card.bonus_type === style) ? card.bonus_value : 0;
            const bonusMult = 1 + (bonusPct / 100);

            for(let s in card.stats) { 
                const d1 = card.stats[s];
                const d1_int = Math.round(d1 * 10); 
                const N = Math.round(d1 * 6);
                const term_numerator = (N * 10 - d1_int) * (L - 1);
                // åˆ†æ¯ã‚’ L-1 ã«ã™ã‚‹ã“ã¨ã§ SSR(49) ã¨ SR(44) ã‚’åˆ‡ã‚Šåˆ†ã‘
                const term = Math.floor(term_numerator / (L - 1));
                const vBase_x10 = d1_int + term;
                const val_x10 = Math.round(vBase_x10 * mult * bonusMult);
                totals_x10[s] = (totals_x10[s] || 0) + val_x10;
            }
            if(card.abilities && card.abilities[0]) saList.add(card.abilities[0]);
        });

        const resDiv = document.getElementById('totalResults'); 
        resDiv.innerHTML = '<h4>ç‰¹ç·´ ä¸Šæ˜‡å€¤ vs Gap</h4>';
        STATS.forEach(s => {
            const nowVal = parseFloat(document.getElementById(`now_${s}`).value) || 0;
            const maxVal = parseFloat(document.getElementById(`max_${s}`).value) || 0;
            const gap = (maxVal > 0 && nowVal > 0) ? (maxVal - nowVal) : null;
            const gapEl = document.getElementById(`gap_${s}`);
            if(gap !== null) { gapEl.innerHTML = `æ®‹: <b>${gap.toFixed(1)}</b>`; gapEl.style.color = "#fbbf24"; }
            else { gapEl.innerHTML = `æ®‹: -`; gapEl.style.color = "#64748b"; }

            if(totals_x10[s] > 0) {
                const finalVal = totals_x10[s] / 10;
                let color = "#fff", note = "";
                if(gap !== null) {
                    if(finalVal > gap) { color = "#ef4444"; note = ` (${(finalVal-gap).toFixed(1)}éå‰°)`; }
                    else if(finalVal >= gap * 0.9) color = "#22c55e";
                }
                resDiv.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px solid #333; padding:2px 0;"><span>${s}</span><b style="color:${color}">+${finalVal.toFixed(1)}${note}</b></div>`; 
            }
        });

        const saDiv = document.getElementById('saResults'); 
        saDiv.innerHTML = '<h4>äºˆå®šã‚¹ã‚­ãƒ«/ã‚¢ãƒ“</h4>';
        saList.forEach(name => {
            const s = skillsDB.find(i=>i.name===name), a = abilitiesDB.find(i=>i.name===name);
            if(s) {
                let areaH = '<div class="sa-result-area">';
                (s.area || Array(9).fill(0)).forEach(v => areaH += `<div class="sa-result-cell ${v?'active':''}"></div>`);
                saDiv.innerHTML += `<div style="display:flex; align-items:center; margin-bottom:5px; width:100%;">${areaH}<div style="flex:1; min-width:0; white-space:nowrap;"><span class="tag tag-skill">S</span><b>${name}</b><br><small>${s.value}%</small></div></div>`;
            }
            if(a) saDiv.innerHTML += `<div style="margin-bottom:5px; width:100%; white-space:nowrap;"><span class="tag tag-ability">A</span><b>${name}</b><br><small>${a.condition || ''}</small></div>`;
        });
        initSimSlots();
    }

    // ãƒ“ãƒ¼ãƒ ã‚µãƒ¼ãƒæœ€é©åŒ– (é‡è¤‡è¨±å¯)
    window.runAutoSim = () => {
        if(cardsDB.length === 0) return alert("ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        const style = document.getElementById('traineeStyle').value;
        const targetPct = parseInt(document.getElementById('targetPct').value) / 100;
        const mult = parseFloat(document.getElementById('conditionMod').value);

        const gaps = {};
        STATS.forEach(s => {
            const now = parseFloat(document.getElementById(`now_${s}`).value) || 0, max = parseFloat(document.getElementById(`max_${s}`).value) || 0;
            gaps[s] = (max > 0) ? Math.max(0, max - now) * targetPct : 999999;
        });

        const optDB = cardsDB.map((card, idx) => {
            const L = card.rarity === 'SSR' ? 50 : 45, bMult = (card.bonus_type === style) ? (1 + (card.bonus_value/100)) : 1.0;
            const vals = {};
            STATS.forEach(s => {
                const d1 = card.stats[s] || 0; if(d1===0) return;
                const d1_i = Math.round(d1*10), N = Math.round(d1*6);
                vals[s] = Math.round((d1_i + Math.floor(((N*10-d1_i)*(L-1))/(L-1))) * mult * bMult);
            });
            return { id: idx, vals: vals };
        });

        const getScore = (sums) => {
            let sc = 0; STATS.forEach(s => sc += Math.min((sums[s]||0)/10, gaps[s])); return sc;
        };

        let beam = [{ idxs: [], sums: {}, score: 0 }];
        const WIDTH = 2000;

        for(let step=0; step<6; step++) {
            let next = [];
            for(const node of beam) {
                for(const card of optDB) {
                    const nSums = { ...node.sums };
                    for(const s in card.vals) nSums[s] = (nSums[s]||0) + card.vals[s];
                    next.push({ idxs: [...node.idxs, card.id], sums: nSums, score: getScore(nSums) });
                }
            }
            beam = next.sort((a,b)=>b.score - a.score).slice(0, WIDTH);
        }
        selectedSlots = beam[0].idxs.map(i => cardsDB[i]);
        updateCalc();
        alert(`æœ€é©åŒ–å®Œäº† (åˆè¨ˆæœ‰åŠ¹ä¸Šæ˜‡å€¤: +${beam[0].score.toFixed(1)})`);
    };

    // --- é«˜ç²¾åº¦OCR (V31çµ±åˆç‰ˆ) ---
    const OCR_GRID_DEFS = [
        { name: "æ±ºå®šåŠ›", r: 0, c: 0 }, { name: "ã‚·ãƒ§ãƒ¼ãƒˆãƒ‘ã‚¹", r: 0, c: 1 }, { name: "çªç ´åŠ›", r: 0, c: 2 }, { name: "ã‚¿ãƒƒã‚¯ãƒ«", r: 0, c: 3 }, { name: "ã‚¸ãƒ£ãƒ³ãƒ—", r: 0, c: 4 }, { name: "èµ°åŠ›", r: 0, c: 5 },
        { name: "ã‚­ãƒƒã‚¯åŠ›", r: 1, c: 0 }, { name: "ãƒ­ãƒ³ã‚°ãƒ‘ã‚¹", r: 1, c: 1 }, { name: "ã‚­ãƒ¼ãƒ—åŠ›", r: 1, c: 2 }, { name: "ãƒ‘ã‚¹ã‚«ãƒƒãƒˆ", r: 1, c: 3 }, { name: "ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ", r: 1, c: 4 }, { name: "æ•æ·æ€§", r: 1, c: 5 },
        { name: "å†·é™ã•", r: 2, c: 0 }, { name: "ã‚­ãƒƒã‚¯ç²¾åº¦", r: 2, c: 1 }, { name: "ãƒœãƒ¼ãƒ«ã‚¿ãƒƒãƒ", r: 2, c: 2 }, { name: "ãƒãƒ¼ã‚¯", r: 2, c: 3 }, { name: "ã‚¹ã‚¿ãƒŸãƒŠ", r: 2, c: 4 }
    ];

    async function handleOCR(input) {
        const file = input.files[0];
        if (!file) return;
        const statusEl = document.getElementById('ocrStatus');
        statusEl.innerText = "èª­ã¿å–ã‚Šä¸­...";

        const img = new Image();
        img.onload = async () => {
            const scale = 3.5;
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = img.width * scale; cvs.height = img.height * scale;
            ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
            
            const imageData = ctx.getImageData(0, 0, cvs.width, cvs.height);
            const d = imageData.data;
            const grayData = new Uint8Array(cvs.width * cvs.height);
            for (let i = 0; i < d.length; i += 4) {
                const b = (d[i] + d[i+1] + d[i+2]) / 3;
                grayData[i/4] = b;
            }

            // 1. ã‚°ãƒªãƒƒãƒ‰(æ°´å¹³ç·š)æ¤œå‡º
            const scanL = Math.floor(cvs.width * 0.42), scanR = Math.floor(cvs.width * 0.98), scanW = scanR - scanL;
            const lineHits = [];
            for(let y=0; y < cvs.height; y++) {
                let count = 0;
                for(let x=scanL; x < scanR; x++) if(grayData[y * cvs.width + x] > 115) count++;
                if(count > scanW * 0.55) lineHits.push(y);
            }
            const rowYs = [];
            if(lineHits.length > 0) {
                let group = [lineHits[0]];
                for(let i=1; i < lineHits.length; i++){
                    if(lineHits[i] - lineHits[i-1] < 20) group.push(lineHits[i]);
                    else { rowYs.push(group[Math.floor(group.length/2)]); group = [lineHits[i]]; }
                }
                rowYs.push(group[Math.floor(group.length/2)]);
            }
            if(rowYs.length < 3) { statusEl.innerText = "ã‚°ãƒªãƒƒãƒ‰æ¤œå‡ºå¤±æ•—"; return; }
            const targetRows = rowYs.slice(-3);

            // 2. åˆ—ä½ç½®ã®ç¢ºå®š
            let islands = [];
            const refY = targetRows[0] - Math.floor(80 * scale / 3), refH = Math.floor(60 * scale / 3);
            const hProj = new Array(scanW).fill(0);
            for(let x=0; x < scanW; x++) for(let y=refY; y < refY+refH; y++) if(grayData[y * cvs.width + (scanL+x)] > 120) hProj[x]++;
            
            let inIsland = false, sX = 0;
            for(let x=0; x < scanW; x++){
                if(!inIsland && hProj[x] > 2) { inIsland = true; sX = x; }
                else if(inIsland && hProj[x] <= 2) {
                    let gap = 0; while(x+gap < scanW && hProj[x+gap] <= 2) gap++;
                    if(gap < 20) x += gap;
                    else { inIsland = false; if(x - sX > 100) islands.push({x: scanL + sX, w: x - sX}); }
                }
            }
            let xCoords = [];
            if (islands.length >= 2) {
                const pitch = (islands[islands.length-1].x - islands[0].x) / (islands.length-1);
                const startX = islands[0].x - (Math.round((islands[0].x - scanL) / pitch) * pitch);
                for(let c=0; c<6; c++) xCoords.push({ x: startX + (c * pitch), w: islands[0].w });
            } else { statusEl.innerText = "åˆ—ä½ç½®ç‰¹å®šå¤±æ•—"; return; }

            // 3. OCRãƒ—ãƒ­ã‚»ã‚¹
            const worker = await Tesseract.createWorker('eng');
            await worker.setParameters({ tessedit_char_whitelist: '0123456789/', tessedit_pageseg_mode: '7' });

            for (let i = 0; i < OCR_GRID_DEFS.length; i++) {
                const def = OCR_GRID_DEFS[i];
                const xObj = xCoords[def.c];
                const cropW = Math.floor(xObj.w + 65), cropX = Math.floor(xObj.x - 48);
                const cropH = Math.floor(100 * scale / 3), cropY = targetRows[def.r] - cropH + 5;
                
                const process = async (thresh) => {
                    const tCvs = document.createElement('canvas');
                    tCvs.width = cropW + 100; tCvs.height = cropH + 100;
                    const tCtx = tCvs.getContext('2d');
                    tCtx.fillStyle = "white"; tCtx.fillRect(0,0,tCvs.width,tCvs.height);
                    const sCvs = document.createElement('canvas');
                    sCvs.width = cropW; sCvs.height = cropH;
                    const sCtx = sCvs.getContext('2d');
                    sCtx.drawImage(img, cropX/scale, cropY/scale, cropW/scale, cropH/scale, 0, 0, cropW, cropH);
                    const sd = sCtx.getImageData(0,0,cropW,cropH);
                    for(let j=0; j<sd.data.length; j+=4){
                        const v = ((sd.data[j]+sd.data[j+1]+sd.data[j+2])/3 > thresh) ? 0 : 255;
                        sd.data[j]=sd.data[j+1]=sd.data[j+2]=v;
                    }
                    const cutY = Math.floor(cropH * 0.85);
                    for(let y=cutY; y<cropH; y++) for(let x=0; x<cropW; x++) {
                        const idx = (y*cropW+x)*4; sd.data[idx]=sd.data[idx+1]=sd.data[idx+2]=255;
                    }
                    sCtx.putImageData(sd, 0, 0);
                    tCtx.drawImage(sCvs, 50, 50);
                    const { data: { text } } = await worker.recognize(tCvs);
                    return text.trim().replace(/[^0-9/]/g, '');
                };

                const r1 = await process(110);
                const r2 = await process(135);
                let clean = (r2.includes('/') && r2.length >= 5) ? r2 : r1;

                let n = "", m = "";
                if (clean.includes('/')) {
                    const p = clean.split('/'); n = p[0].substring(0,3); m = p[1].substring(0,3);
                } else if (clean.length >= 5) {
                    n = clean.substring(0,3); m = clean.substring(3,6);
                } else if (clean.length >= 3) {
                    n = clean.substring(0,3);
                }

                if (n) document.getElementById(`now_${def.name}`).value = n;
                if (m) document.getElementById(`max_${def.name}`).value = m;
                statusEl.innerText = `è§£æä¸­... (${i+1}/17)`;
            }

            statusEl.innerText = "è§£æå®Œäº†";
            await worker.terminate();
            updateCalc();
        };
        img.src = URL.createObjectURL(file);
    }

    // --- ç®¡ç†æ©Ÿèƒ½ (GitHubé€£æº ã»ã‹) ---
    async function pushToGH(file, data, msg) {
        const token = document.getElementById('ghToken').value, repo = document.getElementById('ghRepo').value;
        if(!token || !repo) return alert("GitHubè¨­å®šä¸è¶³");
        const url = `https://api.github.com/repos/${repo}/contents/data/${file}`;
        try {
            const g = await fetch(url, { headers:{'Authorization':`token ${token}`} });
            const sha = g.ok ? (await g.json()).sha : null;
            const res = await fetch(url, { method:'PUT', headers:{'Authorization':`token ${token}`}, body: JSON.stringify({ message:msg, sha:sha, content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))) }) });
            return res.ok;
        } catch(e) { return false; }
    }

    function showTab(id) { document.querySelectorAll('.content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
    function openModal(i) { activeSlotIndex=i; const m=document.getElementById('modalList'); m.innerHTML='<div class="card-box" onclick="selectSlot(null)">ï¼ˆç©ºï¼‰</div>'; cardsDB.forEach((c,idx)=>m.innerHTML+=`<div class="card-box" onclick="selectSlot(${idx})">${c.title}<br><b>${c.name}</b></div>`); document.getElementById('cardModal').style.display='block'; }
    function selectSlot(i) { selectedSlots[activeSlotIndex] = i===null?null:cardsDB[i]; document.getElementById('cardModal').style.display='none'; updateCalc(); }
    function initSimSlots() { const g=document.getElementById('simSlots'), s=document.getElementById('traineeStyle').value; g.innerHTML=''; selectedSlots.forEach((c,i)=>{ let h=`æ  ${i+1}`; if(c){ const on=(c.bonus_type===s); h=`<div style="font-weight:bold;font-size:0.7rem;">${c.name}</div><div class="${on?'bonus-on':'bonus-off'}" style="font-size:0.6rem;">${c.bonus_type}+${c.bonus_value}%</div>`; } g.innerHTML+=`<div onclick="openModal(${i})" class="${c?'slot-active':'slot-empty'}" style="height:65px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center;padding:2px;">${h}</div>`; }); }
    function renderCardList() { const l=document.getElementById('masterList'); l.innerHTML=''; cardsDB.forEach((c,idx)=>l.innerHTML+=`<div class="list-item"><b>${c.name}</b><div style="display:flex;gap:5px;"><button class="btn-edit" onclick="loadCardToEditor(cardsDB[${idx}])">ç·¨é›†</button><button class="btn-edit" style="background:#ef4444;" onclick="deleteCard(${idx})">å‰Šé™¤</button></div></div>`); }
    function renderSAList() { const l=document.getElementById('saList'); l.innerHTML=''; skillsDB.forEach(s=>l.innerHTML+=`<div class="list-item"><span><span class="tag tag-skill">S</span>${s.name}</span><div style="display:flex;gap:5px;"><button class="btn-edit" onclick="loadSA('skill','${s.name}')">ç·¨é›†</button><button class="btn-edit" style="background:#ef4444;" onclick="deleteSA('skill','${s.name}')">å‰Šé™¤</button></div></div>`); abilitiesDB.forEach(a=>l.innerHTML+=`<div class="list-item"><span><span class="tag tag-ability">A</span>${a.name}</span><div style="display:flex;gap:5px;"><button class="btn-edit" onclick="loadSA('ability','${a.name}')">ç·¨é›†</button><button class="btn-edit" style="background:#ef4444;" onclick="deleteSA('ability','${a.name}')">å‰Šé™¤</button></div></div>`); }
    function updateAutoComplete() { const l=document.getElementById('skillList'), s=document.getElementById('styleSuggestions'); l.innerHTML=''; s.innerHTML=''; [...skillsDB,...abilitiesDB].forEach(i=>l.innerHTML+=`<option value="${i.name}">`); const st=new Set(); cardsDB.forEach(c=>st.add(c.bonus_type)); st.forEach(i=>s.innerHTML+=`<option value="${i}">`); }
    function loadCardToEditor(d) { if(!d){ document.querySelectorAll('.edit-val').forEach(i=>i.value=''); return; } document.getElementById('editName').value=d.name; document.getElementById('editTitle').value=d.title; document.getElementById('editRarity').value=d.rarity; document.getElementById('editBonusType').value=d.bonus_type; document.getElementById('editBonusVal').value=d.bonus_value; document.getElementById('editAbilityName').value=d.abilities[0]||''; document.querySelectorAll('.edit-val').forEach(i=>i.value=d.stats[i.dataset.stat]||''); }
    async function saveCardToGH() {
        const name=document.getElementById('editName').value, title=document.getElementById('editTitle').value; if(!name) return;
        const stats={}; document.querySelectorAll('.edit-val').forEach(i=>{if(i.value) stats[i.dataset.stat]=parseFloat(i.value)});
        const nc = { title, name, rarity:document.getElementById('editRarity').value, bonus_type:document.getElementById('editBonusType').value, bonus_value:parseFloat(document.getElementById('editBonusVal').value)||0, abilities:[document.getElementById('editAbilityName').value], stats };
        const i=cardsDB.findIndex(x=>x.name===name&&x.title===title); if(i>=0) cardsDB[i]=nc; else cardsDB.push(nc);
        if(await pushToGH('cards.json',cardsDB,"Update Card")) { alert("ä¿å­˜æˆåŠŸ"); renderCardList(); }
    }
    async function deleteCard(idx) { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; cardsDB.splice(idx,1); await pushToGH('cards.json',cardsDB,"Delete Card"); renderCardList(); }
    async function batchRegisterCards() { try { const d=JSON.parse(document.getElementById('aiPasteCard').value); (Array.isArray(d)?d:[d]).forEach(c=>{const i=cardsDB.findIndex(x=>x.name===c.name&&x.title===c.title); if(i>=0)cardsDB[i]=c; else cardsDB.push(c);}); await pushToGH('cards.json',cardsDB,"Bulk Update"); alert("ä¿å­˜æˆåŠŸ"); renderCardList(); } catch(e){alert("JSONã‚¨ãƒ©ãƒ¼");} }
    function toggleAreaGrid() { document.getElementById('areaContainer').style.display = document.getElementById('saType').value==='skill'?'block':'none'; }
    window.loadSA = (type, name) => {
        const db = type==='skill'?skillsDB:abilitiesDB, item = db.find(i=>i.name===name); if(!item) return;
        document.getElementById('saType').value = type; toggleAreaGrid();
        document.getElementById('saName').value = item.name; document.getElementById('saValue').value = item.value||''; document.getElementById('saCondition').value = item.condition||'';
        document.querySelectorAll('input[name="sa_tgt"]').forEach(c => c.checked = item.targets?.includes(c.value));
        const cells = document.querySelectorAll('.area-cell'); cells.forEach((c,idx) => { c.classList.remove('active'); if(type==='skill'&&item.area?.[idx]) c.classList.add('active'); });
    };
    window.saveSA = async () => {
        const type=document.getElementById('saType').value, name=document.getElementById('saName').value; if(!name) return;
        const tgts = Array.from(document.querySelectorAll('input[name="sa_tgt"]:checked')).map(c=>c.value);
        const data = { name, value:parseFloat(document.getElementById('saValue').value)||0, targets:tgts };
        if(type==='skill'){ data.area = Array.from(document.querySelectorAll('.area-cell')).map(c=>c.classList.contains('active')?1:0); const i=skillsDB.findIndex(s=>s.name===name); if(i>=0)skillsDB[i]=data; else skillsDB.push(data); await pushToGH('skills.json',skillsDB,"Update Skill"); }
        else { data.condition = document.getElementById('saCondition').value; const i=abilitiesDB.findIndex(a=>a.name===name); if(i>=0) abilitiesDB[i]=data; else abilitiesDB.push(data); await pushToGH('abilities.json',abilitiesDB,"Update Ability"); }
        alert("ä¿å­˜å®Œäº†"); renderSAList(); updateAutoComplete();
    };
    window.deleteSA = async (type, name) => { if(!confirm("å‰Šé™¤ï¼Ÿ")) return; if(type==='skill') skillsDB=skillsDB.filter(s=>s.name!==name); else abilitiesDB=abilitiesDB.filter(a=>a.name!==name); await pushToGH(type==='skill'?'skills.json':'abilities.json', type==='skill'?skillsDB:abilitiesDB, "Delete SA"); renderSAList(); };
    async function batchRegisterSA() { try { const d=JSON.parse(document.getElementById('aiPasteSA').value); if(d.skills) d.skills.forEach(s=>{const i=skillsDB.findIndex(x=>x.name===s.name); if(i>=0)skillsDB[i]=s; else skillsDB.push(s);}); if(d.abilities) d.abilities.forEach(a=>{const i=abilitiesDB.findIndex(x=>x.name===a.name); if(i>=0)abilitiesDB[i]=a; else abilitiesDB.push(a);}); await pushToGH('skills.json',skillsDB,"Update"); await pushToGH('abilities.json',abilitiesDB,"Update"); alert("ä¿å­˜æˆåŠŸ"); renderSAList(); } catch(e){alert("JSONã‚¨ãƒ©ãƒ¼");} }
</script>
</body>
</html>
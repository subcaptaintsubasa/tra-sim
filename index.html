<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特練図鑑 & Sim</title>
    <!-- Google API Scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <!-- OCR Lib -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- ▼▼ ヘッダー ▼▼ -->
<header class="app-header">
    <button class="icon-btn" onclick="toggleDrawer()"><i class="fa-solid fa-bars"></i></button>
    
    <!-- モード切替スイッチ -->
    <div class="mode-switch-container">
        <button id="btnModeView" class="mode-btn active" onclick="setAppMode('view')">図鑑</button>
        <button id="btnModeMy" class="mode-btn" onclick="setAppMode('mycards')">所持</button>
    </div>

    <!-- ツール群 (CSSでDatabase以外では非表示になります) -->
    <div class="header-tools">
        <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="globalSearch" placeholder="名前・称号..." oninput="filterDatabase()">
            <!-- クリアボタン -->
            <button id="searchClearBtn" class="search-clear-btn" onclick="clearSearch()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        
        <!-- 表示形式切り替え -->
        <button id="btnViewType" class="icon-btn" onclick="toggleViewType()" style="font-size:1rem;">
            <i class="fa-solid fa-list"></i>
        </button>

        <!-- ★追加: 選択モード切り替えボタン -->
        <button id="btnSelectMode" class="icon-btn" onclick="toggleSelectMode()">
            <i class="fa-regular fa-square-check"></i>
        </button>

        <!-- フィルタボタン -->
        <button class="icon-btn" onclick="openFilterModal()"><i class="fa-solid fa-filter"></i></button>
    </div>
</header>

<!-- ドロワーメニュー -->
<div id="drawerOverlay" class="drawer-overlay" onclick="toggleDrawer()"></div>
<nav id="appDrawer" class="app-drawer">
    <div class="drawer-header">MENU</div>
    <a href="#" class="drawer-item active" onclick="switchView('database')"><i class="fa-solid fa-book"></i> 選手図鑑 (DB)</a>
    <a href="#" class="drawer-item" onclick="switchView('sim')"><i class="fa-solid fa-calculator"></i> シミュレータ</a>
    
    <!-- 一般ユーザー向けバックアップ -->
    <a href="#" class="drawer-item" onclick="switchView('backup')"><i class="fa-solid fa-cloud"></i> データバックアップ</a>

    <!-- 開発者向け (初期非表示) -->
    <div id="adminLinks" style="display:none; border-top:1px solid #334155; margin-top:10px; padding-top:10px;">
        <div style="padding:0 20px 10px; font-size:0.7rem; color:#64748b;">DEVELOPER</div>
        <a href="#" class="drawer-item" onclick="switchView('admin-card')"><i class="fa-solid fa-database"></i> データ管理 (Card)</a>
        <a href="#" class="drawer-item" onclick="switchView('admin-skill')"><i class="fa-solid fa-wand-magic-sparkles"></i> スキル管理</a>
        <a href="#" class="drawer-item" onclick="logoutDev()"><i class="fa-solid fa-right-from-bracket"></i> ログアウト</a>
    </div>

    <!-- 開発者ログインボタン -->
    <a href="#" id="devLoginBtn" class="drawer-item" onclick="openDevModal()"><i class="fa-solid fa-terminal"></i> 開発者オプション</a>
</nav>

<!-- メインコンテンツ -->
<main id="mainContainer">
    <!-- 1. データベース & MyCards 共通コンテナ -->
    <div id="view-database" class="view-content active">
        <div id="activeFilters" style="margin-bottom:10px; display:flex; gap:5px; flex-wrap:wrap;"></div>
        <!-- グリッド/リストのクラスはJSで制御 -->
        <div id="dbGrid" class="card-grid-visual"></div>
    </div>

    <!-- 2. シミュレーター -->
    <div id="view-sim" class="view-content">
        <div class="card-box" style="border-color: #3b82f6;">
            <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleDisp('inputContentArea')">
                <label style="color:#3b82f6; font-weight:bold;">▼ 選手ステータス / ポジション設定</label>
                <span style="font-size:0.8rem;">開閉</span>
            </div>
            <div id="inputContentArea" style="display:block;">
                <div style="margin-top:10px; border-bottom:1px dashed #334155; padding-bottom:10px;">
                    <label style="font-size:0.7rem; color:#94a3b8; display:block; margin-bottom:5px;">ポジション & プレースタイル</label>
                    <div id="posStyleSummary" class="selected-summary" style="display:none; align-items:center; justify-content:space-between; background:rgba(0,0,0,0.3); padding:8px; border-radius:6px; cursor:pointer; border:1px solid #334155;" onclick="expandSelection()">
                        <div style="display:flex; align-items:center;">
                            <img id="summaryIcon" src="" style="height:32px; width:32px; object-fit:contain; background:#0f172a; border-radius:4px; padding:2px; margin-right:10px; border:1px solid #333;">
                            <span id="summaryText" style="font-weight:bold; font-size:0.9rem; color:#f1f5f9;"></span>
                        </div>
                        <span style="font-size:0.75rem; color:var(--primary);">変更する</span>
                    </div>
                    <div id="posStyleSelection">
                        <div id="posGrid" class="pos-grid"></div>
                        <div id="styleGrid" class="style-grid" style="margin-top:5px;"></div>
                    </div>
                </div>
                <div style="margin-top:10px; border-bottom:1px dashed #334155; padding-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <input type="file" id="ocrUpload" accept="image/*" style="display:none;" onchange="handleOCR(this)">
                        <button class="btn" style="background:#3b82f6; width:auto; font-size:0.75rem; padding:5px 15px;" onclick="document.getElementById('ocrUpload').click()">画像読込 (OCR)</button>
                        <span id="ocrStatus" style="font-size:0.7rem; color:var(--skill);"></span>
                        <div style="margin-left: auto; display:flex; gap:5px;">
                            <button class="btn btn-sm btn-accent" style="width:auto;" onclick="openSaveModal()">💾 保存</button>
                            <button class="btn btn-sm btn-primary" style="width:auto;" onclick="openLoadModal()">📂 読込</button>
                        </div>
                    </div>
                </div>
                <div id="statInputArea" class="stat-grid" style="margin-top:10px;"></div>
            </div>
        </div>
        <div id="selectionArea" class="selector-container">
            <label style="color:var(--accent); font-weight:bold; font-size:0.8rem;">育成ターゲット設定</label>
            <div style="margin-top:5px;">
                <label style="font-size:0.7rem; color:var(--skill);">必須スキル</label>
                <div id="skillTargetContainer" class="tag-selector-grid"></div>
                <label style="font-size:0.7rem; color:var(--ability); margin-top:8px; display:block;">必須アビリティ</label>
                <div id="abilityTargetContainer" class="tag-selector-grid"></div>
            </div>
        </div>
        <div id="simSlots" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div class="card-box" style="margin-bottom:0;">
                <label>コンディション</label>
                <div class="condition-selector">
                    <button type="button" class="cond-btn active" onclick="changeCondition(1.0, this)">普通</button>
                    <button type="button" class="cond-btn" onclick="changeCondition(1.25, this)">好調</button>
                    <button type="button" class="cond-btn" onclick="changeCondition(1.5, this)">絶好調</button>
                </div>
                <input type="hidden" id="conditionMod" value="1.0">
            </div>
            <div class="card-box" style="margin-bottom:0; border: 2px solid var(--skill);">
                <label style="color:var(--skill); font-weight:bold; font-size:0.8rem;">🤖 最適化オート編成</label>
                <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                    <input type="range" id="targetPct" min="50" max="120" value="100" step="5" oninput="document.getElementById('targetPctDisp').innerText=this.value">
                    <span id="targetPctDisp" style="font-size:0.7rem; min-width:25px;">100</span>%
                </div>
                <button class="btn" style="background:var(--skill); color:#000; font-size:0.75rem; padding:5px;" onclick="runAutoSim()">所持カードから最適化</button>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div id="totalResults" class="card-box"></div>
            <div id="saResults" class="card-box"></div>
        </div>
    </div>

    <!-- 3. データバックアップ -->
    <div id="view-backup" class="view-content">
        <!-- Google Drive Backup UI -->
        <div class="card-box" style="border:2px solid var(--accent); margin-bottom: 20px;">
            <h4 style="color:var(--accent); margin-top:0; border-bottom:1px dashed #334155; padding-bottom:5px;">
                <i class="fa-brands fa-google-drive"></i> クラウドバックアップ
            </h4>
            <p style="font-size:0.75rem; color:#ccc; margin:10px 0;">
                所持カードや育成データをGoogle Driveに保存・復元します。<br>
                機種変更時や、複数端末でのデータ共有にご利用ください。
            </p>

            <!-- 未ログイン時 -->
            <button id="gDriveAuthBtn" class="btn" style="background:#fff; color:#333; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px;" onclick="handleAuthClick()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" alt="Google">
                Googleでログイン
            </button>

            <!-- ログイン後 -->
            <div id="gDriveActions" style="display:none; flex-direction:column; gap:8px;">
                <div style="font-size:0.7rem; color:#22c55e; display:flex; align-items:center; gap:5px;">
                    <i class="fa-solid fa-circle-check"></i> アカウント連携済み
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-accent" onclick="saveToDrive()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> ドライブに保存
                    </button>
                    <button class="btn btn-primary" onclick="restoreFromDrive()">
                        <i class="fa-solid fa-cloud-arrow-down"></i> ドライブから復元
                    </button>
                </div>
                <button class="btn btn-sm" style="background:#ef4444; width:auto; align-self:flex-end;" onclick="handleSignoutClick()">ログアウト</button>
            </div>
            
            <div id="driveStatus" style="font-size:0.75rem; font-weight:bold; color:#fbbf24; margin-top:8px; min-height:1.2em;"></div>
        </div>

        <!-- 手動バックアップ (JSON) -->
        <div class="card-box" style="margin-top:10px;">
            <h4 style="color:#94a3b8;">手動バックアップ (JSONテキスト)</h4>
            <textarea id="backupArea" style="height:60px; font-size:0.7rem; color:#fff; background:#000; border:1px solid #333; width:100%;" placeholder="ここにデータが出力されます"></textarea>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="btn btn-sm btn-primary" onclick="exportBackup()">書き出し</button>
                <button class="btn btn-sm btn-accent" onclick="importBackup()">読み込み</button>
            </div>
        </div>
    </div>

    <!-- 4. データ管理 (Admin) - 開発者限定 -->
    <div id="view-admin-card" class="view-content">
        <div class="card-box" style="margin-bottom:20px; background:rgba(239, 68, 68, 0.1); border:1px solid #ef4444;">
            <h4 style="color:#ef4444; margin:0;"><i class="fa-solid fa-triangle-exclamation"></i> 開発者モード</h4>
            <p style="font-size:0.7rem; color:#ccc;">ここではマスターデータの編集・削除が行われます。変更は即座にGitHubへ反映されます。</p>
        </div>

        <div class="card-box">
            <h4>JSON一括登録 (Card)</h4>
            <textarea id="aiPasteCard" placeholder="カードデータを貼り付け" style="height:60px;"></textarea>
            <button class="btn btn-accent" onclick="batchRegisterCards()">一括保存</button>
        </div>
        
        <div class="card-box" id="cardEditor" style="margin-top:10px; border:1px dashed #334155;">
            <h4>個別カード編集</h4>
            <div style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px dashed #333;">
                <label style="font-size:0.75rem; color:#94a3b8;">カード画像</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="file" id="cardImgUpload" accept="image/*" style="font-size:0.8rem;">
                    <button class="btn btn-sm btn-primary" onclick="uploadCardImage()">Upload</button>
                </div>
                <p id="imgUploadStatus" style="font-size:0.7rem; color:var(--accent); margin-top:2px;"></p>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                <input id="editName" placeholder="選手名">
                <input id="editTitle" placeholder="【称号】">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                <select id="editRarity"><option>SSR</option><option>SR</option></select>
                <select id="editGrowth"><option value="6">成長: 通常(6倍)</option><option value="3" style="color:#fbbf24;">成長: 3倍</option></select>
            </div>
            <div style="margin-top:5px;"><input id="editAbilityName" placeholder="スキル/アビ名" list="skillList"></div>
            <div style="margin-top:10px; border:1px dashed #555; padding:5px;">
                <label style="font-size:0.7rem;">ボーナス条件</label>
                <div id="editBonusList"></div>
                <button class="btn btn-sm" onclick="addBonusRow()">+ 条件追加</button>
            </div>
            <div class="stat-grid" id="editStatsGrid"></div>
            <button class="btn btn-accent" onclick="saveCardToGH()">保存</button>
        </div>
        <div id="masterList"></div>
    </div>

    <!-- 5. スキル管理 (Admin) - 開発者限定 -->
    <div id="view-admin-skill" class="view-content">
        <div class="card-box" id="saEditor" style="border:2px solid var(--primary)">
            <h4>スキル/アビリティ編集</h4>
            <select id="saType" onchange="toggleAreaGrid()"><option value="skill">SKILL (%)</option><option value="ability">ABILITY (固定値)</option></select>
            <input id="saName" placeholder="名称" style="margin-top:5px;">
            <input id="saValue" placeholder="数値" type="number" style="margin-top:5px;">
            <input id="saCondition" placeholder="発動条件" style="margin-top:5px;">
            <div id="saTargets" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(90px, 1fr)); gap:5px; margin-top:10px;"></div>
            <div id="areaContainer" style="margin-top:10px;"><label>発動エリア:</label><div class="area-grid" id="saAreaGrid"></div></div>
            <button class="btn btn-accent" onclick="saveSA()">保存</button>
            <button class="btn" style="margin-top:10px; background:#444;" onclick="document.getElementById('saListArea').style.display='block'">一覧を表示</button>
        </div>
        <div id="saListArea" style="display:none;">
            <div class="card-box"><textarea id="aiPasteSA" placeholder="JSON一括貼り付け" style="height:50px;"></textarea><button class="btn btn-sm" onclick="batchRegisterSA()">JSON保存</button></div>
            <div id="saList"></div>
        </div>
    </div>
</main>

<!-- 一括操作バー -->
<div id="bulkActionBar" class="bulk-action-bar">
    <div class="bulk-info">
        <span id="bulkCount">0</span>枚 選択中
    </div>
    <div class="bulk-tools">
        <button class="btn btn-sm" onclick="execBulkAction('owned', true)" style="background:#22c55e; color:#000;">所持にする</button>
        <button class="btn btn-sm" onclick="execBulkAction('owned', false)" style="background:#334155;">未所持</button>
        <button class="btn btn-sm btn-primary" onclick="execBulkAction('level_max')">Lv.Max</button>
        <button class="btn btn-sm" style="background:#ef4444;" onclick="toggleSelectMode()">終了</button>
    </div>
</div>

<!-- 下部比較トレイ -->
<div id="compareTray" class="tray-container">
    <div class="tray-handle" onclick="toggleTray()">
        <span id="trayCount">比較リスト (0)</span>
        <i class="fa-solid fa-chevron-up"></i>
    </div>
    <div class="tray-content">
        <div id="trayList" class="tray-list"><div class="tray-placeholder">カードをドロップ</div></div>
        <button class="btn btn-sm btn-accent" onclick="runComparison()">比較実行</button>
        <button class="btn btn-sm" style="background:#ef4444;" onclick="clearTray()">クリア</button>
    </div>
</div>

<!-- 詳細フィルタモーダル (Phase 2 修正版) -->
<div id="filterModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 500px; max-height:90vh; display:flex; flex-direction:column;">
        
        <!-- タブヘッダー -->
        <div class="modal-tab-header">
            <button class="modal-tab-btn active" onclick="switchFilterTab('filter')">絞り込み</button>
            <button class="modal-tab-btn" onclick="switchFilterTab('sort')">並び替え</button>
            <button class="icon-btn" style="margin-left:auto; font-size:1.2rem;" onclick="closeFilterModal()">×</button>
        </div>

        <div class="modal-body" style="padding:15px; overflow-y:auto; flex:1;">
            <!-- Tab 1: 絞り込み (Filter) -->
            <div id="tab-filter" class="filter-tab-content active">
                
                <!-- レアリティ & 所持 -->
                <div class="filter-group">
                    <div class="filter-group-title">基本</div>
                    <div class="filter-chips">
                        <div class="chk-btn"><input type="checkbox" id="f_rar_SSR" checked><label for="f_rar_SSR">SSR</label></div>
                        <div class="chk-btn"><input type="checkbox" id="f_rar_SR" checked><label for="f_rar_SR">SR</label></div>
                        <div class="chk-btn"><input type="checkbox" id="f_owned_only"><label for="f_owned_only">所持のみ</label></div>
                    </div>
                </div>

                <!-- スキル/アビリティ所持 -->
                <div class="filter-group">
                    <div class="filter-group-title">習得スキル (いずれか所持)</div>
                    <div class="filter-chips">
                        <div class="chk-btn"><input type="checkbox" id="f_has_skill"><label for="f_has_skill">スキル所持</label></div>
                        <div class="chk-btn"><input type="checkbox" id="f_has_ability"><label for="f_has_ability">アビリティ所持</label></div>
                    </div>
                </div>

                <!-- ポジション & スタイル -->
                <div class="filter-group">
                    <div class="filter-group-title">適性・ボーナス (OR検索)</div>
                    <div class="filter-grid-compact" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:5px;">
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="CF" id="fp_cf"><label for="fp_cf">CF</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="LW" id="fp_lw"><label for="fp_lw">LW</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="RW" id="fp_rw"><label for="fp_rw">RW</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="AM" id="fp_am"><label for="fp_am">AM</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="RM" id="fp_rm"><label for="fp_rm">RM</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="LM" id="fp_lm"><label for="fp_lm">LM</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="DM" id="fp_dm"><label for="fp_dm">DM</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="CM" id="fp_cm"><label for="fp_cm">CM</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="LB" id="fp_lb"><label for="fp_lb">LB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="RB" id="fp_rb"><label for="fp_rb">RB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="CB" id="fp_cb"><label for="fp_cb">CB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_pos" value="GK" id="fp_gk"><label for="fp_gk">GK</label></div>
                    </div>
                    <div class="filter-grid-compact" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ストライカー" id="fs_st"><label for="fs_st">ストライカー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ラインブレイカー" id="fs_lb"><label for="fs_lb">Lブレイカー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ポストプレーヤー" id="fs_ps"><label for="fs_ps">ポストP</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ドリブラー" id="fs_dr"><label for="fs_dr">ドリブラー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="サイドアタッカー" id="fs_sa"><label for="fs_sa">Sアタッカー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="アタッカー" id="fs_at"><label for="fs_at">アタッカー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="パサー" id="fs_pa"><label for="fs_pa">パサー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="セントラルMF" id="fs_cmf"><label for="fs_cmf">セントラルMF</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ハードマーカー" id="fs_hm"><label for="fs_hm">Hマーカー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="攻撃的FB" id="fs_afb"><label for="fs_afb">攻撃的FB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="守備的FB" id="fs_dfb"><label for="fs_dfb">守備的FB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="組立CB" id="fs_mcb"><label for="fs_mcb">組立CB</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="ストッパー" id="fs_stp"><label for="fs_stp">ストッパー</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="スイーパーGK" id="fs_sgk"><label for="fs_sgk">S-GK</label></div>
                        <div class="chk-btn"><input type="checkbox" name="f_sty" value="オーソドックスGK" id="fs_ogk"><label for="fs_ogk">O-GK</label></div>
                    </div>
                </div>

                <!-- 強化パラメータ -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>強化パラメータ (指定項目を持つか)</span>
                        <div style="background:#0f172a; border-radius:4px; padding:2px; display:flex; gap:5px; margin-left:10px;">
                            <label style="font-size:0.65rem; padding:2px 6px; color:#fff;"><input type="radio" name="f_logic" value="OR" checked> OR</label>
                            <label style="font-size:0.65rem; padding:2px 6px; color:#fff;"><input type="radio" name="f_logic" value="AND"> AND</label>
                        </div>
                    </div>
                    <!-- 絞り込み用パラメータID -->
                    <div class="filter-grid-params" id="filterParamsGrid"></div>
                </div>
            </div>

            <!-- Tab 2: 並び替え (Sort) -->
            <div id="tab-sort" class="filter-tab-content" style="display:none;">
                <p style="font-size:0.75rem; color:#94a3b8; margin-bottom:10px;">
                    選択したステータスの<b>合計値</b>が高い順に並び替えます。<br>
                    ※「絞り込み」タブで選択したポジション/スタイルボーナスが計算に適用されます。
                </p>
                
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ソート基準 (複数選択可)</span>
                        <button class="btn btn-sm" style="width:auto; font-size:0.7rem; margin-left:auto;" onclick="document.querySelectorAll('input[name=s_prm]').forEach(c=>c.checked=false)">クリア</button>
                    </div>
                    <!-- ソート用パラメータID (ここが重要) -->
                    <div class="filter-grid-params" id="sortParamsGrid"></div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-title">計算設定</div>
                    <div class="chk-btn" style="width:100%;">
                        <input type="checkbox" id="s_use_my_level">
                        <label for="s_use_my_level">所持カードのレベルを参照する (未所持はLv1)</label>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="btn" style="background:#444;" onclick="resetFilters()">リセット</button>
            <button class="btn btn-primary" onclick="applyFilters()">適用して閉じる</button>
        </div>
    </div>
</div>

<!-- 比較モーダル (Phase 2: Slider Removed) -->
<div id="comparisonModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; height: 90vh;">
        <div class="modal-header">
            <h4>選手比較</h4>
            <button class="btn-close" onclick="document.getElementById('comparisonModal').style.display='none'">×</button>
        </div>
        <div class="modal-body" style="padding:0;">
            <div class="comp-table-wrapper">
                <table class="comp-table" id="compTable"></table>
            </div>
        </div>
    </div>
</div>

<!-- 既存モーダル群 -->
<!-- 詳細モーダル (MyCards & View共通) -->
<div id="cardDetailModal" class="modal-overlay" style="display:none;" onclick="closeCardDetailModal()">
    <!-- コンテンツクリック時は閉じないように stopPropagation -->
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header"><h4 id="cdmTitle">Card Title</h4><button class="btn-close" onclick="closeCardDetailModal()">×</button></div>
        <div class="modal-body" id="cdmBody"></div>
        <!-- フッターはJSで動的に書き換わります -->
        <div class="modal-footer"></div>
    </div>
</div>
<div id="cardModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; padding:20px; overflow-y:auto;">
    <div id="modalList"></div><button class="btn" onclick="document.getElementById('cardModal').style.display='none'">閉じる</button>
</div>
<div id="saModal" class="modal-overlay" style="display:none; z-index:1100;">
    <div class="modal-content" style="max-width:350px;">
        <div class="modal-header"><h4 id="saModalTitle">スキル名</h4><button class="btn-close" onclick="closeSaModal()">×</button></div>
        <div class="modal-body">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;"><span id="saModalType" class="tag">S</span><span id="saModalValue" style="font-size:1.2rem; font-weight:bold; color:var(--primary);"></span></div>
            <div class="card-box" style="margin-bottom:10px;"><label style="font-size:0.7rem; color:#94a3b8;">効果対象</label><div id="saModalTargets" style="font-weight:bold;"></div></div>
            <div id="saModalConditionBox" class="card-box" style="display:none; margin-bottom:10px;"><label style="font-size:0.7rem; color:#94a3b8;">発動条件</label><div id="saModalCondition"></div></div>
            <div id="saModalAreaBox" class="card-box" style="display:none; text-align:center;"><label style="font-size:0.7rem; color:#94a3b8;">発動エリア</label><div class="area-grid" id="saModalAreaGrid" style="margin:5px auto;"></div></div>
        </div>
    </div>
</div>
<div id="profileModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:210; align-items:center; justify-content:center;">
    <div class="card-box" style="width:90%; max-width:400px; max-height:80vh; overflow-y:auto; border:1px solid #334155;">
        <h4 id="profileModalTitle" style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">設定</h4>
        <div id="profileModalContent"></div>
        <button class="btn" style="background:#334155; margin-top:10px;" onclick="closeProfileModal()">閉じる</button>
    </div>
</div>

<!-- 開発者ログインモーダル -->
<div id="devAuthModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:400px;">
        <div class="modal-header">
            <h4>開発者認証</h4>
            <button class="btn-close" onclick="document.getElementById('devAuthModal').style.display='none'">×</button>
        </div>
        <div class="modal-body">
            <p style="font-size:0.8rem; color:#ccc;">GitHub Personal Access Token (Key) を入力してください。</p>
            <input type="password" id="devAuthToken" placeholder="ghp_xxxxxxxxxxxx" style="margin-bottom:10px;">
            <input type="text" id="devAuthRepo" placeholder="username/repository" style="margin-bottom:10px;">
            <div style="font-size:0.7rem; color:#94a3b8;">※認証情報はブラウザに保存され、次回以降は自動ログインされます。</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitDevAuth()">ログイン</button>
        </div>
    </div>
</div>

<div id="admin-status">コマンド入力待機中...</div>
<datalist id="skillList"></datalist>
<datalist id="styleSuggestions"></datalist>

<script src="js/config.js"></script>
<script src="js/drive_sync.js"></script>
<script src="js/data_manager.js"></script>
<script src="js/core_logic.js"></script>
<script src="js/ocr_logic.js"></script>
<script src="js/ui_manager.js"></script>
<script src="js/app.js"></script>

</body>
</html>